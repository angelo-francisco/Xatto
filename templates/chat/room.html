<div class="chat-app">
    <div class="chat-header">
        <div class="header-content">
            {% if not chat.is_private %}
            <img src="{{ chat.image.url }}" alt="Grupo" class="profile-pic group">
            {% else %}
            {% for member in chat.participants.all %}
            {% if member != request.user %}
            <div class="user-profile">
                <img src="{{ member.photo.url }}" alt="{{ member.username }}" class="profile-pic">
                <span class="status-dot"></span>
            </div>
            {% endif %}
            {% endfor %}
            {% endif %}

            <div class="user-info">
                {% if not chat.is_private %}
                <h2 class="chat-title">{{ chat.name }}</h2>
                <span class="members-count">{{ chat.participants.count }} membros</span>
                {% else %}
                {% for member in chat.participants.all %}
                {% if member != request.user %}
                <div class="user-status">
                    <h2 class="username">{{ member.username }}</h2>
                    <span class="status">{{ member.get_status_display }}</span>
                </div>
                {% endif %}
                {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Área de Mensagens -->
    <div class="chat-messages">
        {% for msg in messages %}
        <div class="message-container {% if msg.sender == request.user %}sent{% else %}received{% endif %}">
            <div class="message-bubble">
                <p>{{ msg.content }}</p>
                <div class="message-info">
                    <span class="time">{{ msg.timestamp|time:"H:i" }}</span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="chat-input">
        <div class="input-container">
            <input type="text" placeholder="Digite sua mensagem..." id="chat-message-input">
            <button id="js-chat-input-button" class="send-btn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" fill="currentColor" />
                </svg>
            </button>
        </div>
    </div>
</div>

<script>
    const ws2 = new WebSocket('ws://127.0.0.1:8000/chat/chat-consumer/{{ chat.slug }}/{{ user_slug }}/');
    const chatMessages = document.querySelector(".chat-messages");
    const messageInput = document.getElementById('chat-message-input');

    function parseTimestamp(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function createMessageElement(content, time, isSender) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message-container ${isSender ? 'sent' : 'received'}`;
        messageDiv.innerHTML = `
            <div class="message-bubble">
                <p>${content}</p>
                <div class="message-info">
                    <span class="time">${time}</span>
                    </div>
                    </div>
                    `;
        return messageDiv;
    }

    function sendMessage() {
        const content = messageInput.value.trim();
        if (!content) {
            messageInput.classList.add('shake');
            setTimeout(() => messageInput.classList.remove('shake'), 500);
            return;
        }

        if (ws2.readyState === WebSocket.OPEN) {
            const message = {
                content: content,
                uuid: crypto.randomUUID()
            };

            ws2.send(JSON.stringify(message));
            messageInput.value = '';
        }
    }

    ws2.onmessage = (e) => {
        const { content, timestamp, sender, uuid } = JSON.parse(e.data);
        const time = parseTimestamp(timestamp);
        const isSender = sender === "{{ request.user.username }}";

        const messageElement = createMessageElement(content, time, isSender);
        chatMessages.appendChild(messageElement);

        // Animação de entrada
        messageElement.style.opacity = '0';
        messageElement.style.transform = `translateY(${isSender ? '20px' : '-20px'})`;

        requestAnimationFrame(() => {
            messageElement.style.transition = 'all 0.3s ease-out';
            messageElement.style.opacity = '1';
            messageElement.style.transform = 'translateY(0)';
        });

        // Scroll automático suave
        chatMessages.scrollTo({
            top: chatMessages.scrollHeight,
            behavior: 'smooth'
        });
    };

    document.getElementById('js-chat-input-button').addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => e.key === 'Enter' && sendMessage());

</script>

<style>
    :root {
        --primary: #4a9c7d;
        --primary-dark: #3a7d63;
        --background: #f5f7fb;
        --text-primary: #2d3748;
        --text-secondary: #718096;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .chat-app {
        width: 100%;
        height: 100dvh;
        display: flex;
        flex-direction: column;
        background: var(--background);
        font-family: 'Segoe UI', system-ui, sans-serif;
    }

    .chat-header {
        padding: 1rem;
        background: white;
        box-shadow: var(--shadow);
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .chat-header .header-content {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 10px;
    }

    .profile-pic {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--primary);
    }

    .user-info {
        display: flex;
        flex-direction: column;
    }

    .username {
        font-weight: 600;
        color: var(--text-primary);
    }

    .status {
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    .chat-messages {
        flex: 1;
        padding: 1.5rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .message-container {
        max-width: 75%;
        opacity: 0;
        transform: translateY(20px);
    }

    .message-container.sent {
        margin-left: auto;
    }

    .message-bubble {
        padding: 12px 16px;
        border-radius: 1.25rem;
        background: white;
        box-shadow: var(--shadow);
        position: relative;
        transition: transform 0.2s;
    }

    .message-container.sent .message-bubble {
        background: var(--primary);
        color: white;
        border-radius: 1.25rem 1.25rem 0 1.25rem;
    }

    .message-container.received .message-bubble {
        border-radius: 1.25rem 1.25rem 1.25rem 0;
    }

    .message-info {
        display: flex;
        justify-content: flex-end;
        margin-top: 0.5rem;
    }

    .time {
        font-size: 0.75rem;
        opacity: 0.8;
    }

    .chat-input {
        padding: 1rem;
        background: white;
        box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.05);
    }

    .input-container {
        display: flex;
        gap: 0.5rem;
        background: #f1f5f9;
        border-radius: 2rem;
        padding: 0.5rem 1rem;
    }

    #chat-message-input {
        flex: 1;
        border: none;
        background: transparent;
        padding: 0.5rem;
        font-size: 1rem;
        outline: none;
        transition: all 0.3s;
    }

    #chat-message-input:focus {
        transform: scale(1.02);
    }

    .send-btn {
        background: var(--primary);
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
    }

    .send-btn:hover {
        background: var(--primary-dark);
        transform: rotate(-15deg) scale(1.1);
    }

    .send-btn svg {
        color: white;
    }

    @keyframes shake {

        0%,
        100% {
            transform: translateX(0);
        }

        25% {
            transform: translateX(-5px);
        }

        75% {
            transform: translateX(5px);
        }
    }

    .shake {
        animation: shake 0.15s linear 3;
    }

    @media (max-width: 768px) {
        .message-container {
            max-width: 85%;
        }
    }
</style>